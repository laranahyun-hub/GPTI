<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>○△□S 도형 테스트</title>
<link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fbf6f4;
    --title:#3c2f91;
    --frame:#b9764f;
    --accent:#3c2f91;
    --btn-border:#e6e6e6;
  }
  html,body{height:100%;margin:0}
  body{
    /* [수정 3] 둥근 폰트 추가 및 기존 폰트 대체 */
    font-family:'Averia Serif Libre', cursive, "Pretendard","Noto Sans KR",system-ui,-apple-system,Arial;
    background:var(--bg);color:#222;
    display:flex;flex-direction:column;align-items:center;
    padding:20px 16px 40px;
  }
  h1{color:var(--title);font-size:34px;margin:8px 0 6px;letter-spacing:2px}
  .subtitle{color:var(--title);text-align:center;font-size:14px;margin:0 0 18px}
  .board-wrap{position:relative;width:420px;max-width:92vw}
  #board{
    width:360px;height:360px;margin:0 auto;
    background:#fff;border:4px solid var(--frame);box-sizing:border-box;position:relative;
    touch-action: none; /* 브라우저 줌 방지를 위해 보드 터치 액션은 막음 */
  }
  #inner{
    position:absolute;width:180px;height:180px;left:50%;top:50%;
    transform:translate(-50%,-50%);
    border:4px dashed rgba(183,132,112,0.35);pointer-events:none;
  }
  
  /* 도형 버튼 가로 배치 (원래대로 유지) */
  .tools{display:flex;gap:12px;justify-content:center;margin-top:18px;flex-wrap:wrap}
  
  .tool{width:64px;height:64px;border-radius:14px;border:2px solid var(--btn-border);
    display:flex;align-items:center;justify-content:center;background:#fff;
    font-size:28px;cursor:pointer;box-shadow:0 6px 20px rgba(60,47,145,0.06);
    transition:transform .12s,background .12s,border-color .12s}
  .tool.active{background:#efeefc;border-color:var(--accent);box-shadow:0 10px 26px rgba(60,47,145,0.14)}
  .actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--btn-border);
    background:#fff;color:var(--accent);font-weight:600;cursor:pointer;}
  .btn.primary{background:var(--accent);color:#fff;border:none;box-shadow:0 6px 18px rgba(60,47,145,0.16)}
  .placed{position:absolute;user-select:none;display:flex;align-items:center;justify-content:center;
    box-sizing:border-box;border-radius:8px;transform-origin:center center;}
  .placed .badge{position:absolute;right:4px;bottom:4px;background:var(--accent);color:#fff;font-size:11px;padding:2px 6px;border-radius:8px;z-index: 1;}
  
  .handle{display:none;}
  
  .rotate-handle{position:absolute;width:14px;height:14px;top:-24px;left:50%;transform:translateX(-50%);background:#fff;border:2px solid var(--accent);border-radius:50%;cursor:grab;}
  
  /* [수정 2] 결과 박스 가운데 정렬 */
  #resultBox{width:420px;max-width:92vw;margin:18px auto 0;text-align:left}
  
  .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
  .card h3{margin:0 0 8px;color:var(--accent)}
  .line{margin:8px 0;color:#222;line-height:1.6}
  .scent{margin-top:8px;color:#4b4b4b;font-weight:600}
  @media(max-width:420px){
    #board{width:320px;height:320px}
    #inner{width:160px;height:160px}
    .tool{width:56px;height:56px;font-size:24px}
    #resultBox{width:320px} /* 모바일에서도 폭을 조정하여 중앙 정렬 유지 */
    .card{width:auto;}
  }
</style>
</head>
<body>

<h1>○△□S 도형 테스트</h1>
<div class="subtitle">가장 마음에 드는 도형을 3번, 나머지를 각각 1번씩 배치하세요.</div>

<div class="board-wrap">
  <div id="board"><div id="inner"></div></div>
</div>

<div class="tools">
  <div class="tool active" data-shape="circle">○</div>
  <div class="tool" data-shape="triangle">△</div>
  <div class="tool" data-shape="square">□</div>
  <div class="tool" data-shape="wave">S</div>
</div>

<div class="actions">
  <button id="undo" class="btn">Undo</button>
  <button id="reset" class="btn">초기화</button>
  <button id="analyze" class="btn primary">결과 보기</button>
</div>

<div id="resultBox">
  <div class="card">
    <h3>검사 결과</h3>
    <div id="resultContent">
      <div class="line">도형을 배치한 뒤 '결과 보기'를 눌러주세요.</div>
    </div>
  </div>
</div>

<script>
const board=document.getElementById('board');
const tools=document.querySelectorAll('.tool');
let currentTool='circle', placed=[], orderCounter=0;
const resultContent=document.getElementById('resultContent');

// 전역 터치 카운터를 사용하여 핀치줌과 이동을 구분합니다.
let touchCount = 0;
document.addEventListener('touchstart', e => { touchCount = e.touches.length; }, { passive: false });
document.addEventListener('touchend', e => { touchCount = e.touches.length; });
document.addEventListener('touchcancel', e => { touchCount = e.touches.length; });

tools.forEach(t=>{
  t.addEventListener('click',()=>{
    tools.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentTool=t.dataset.shape;
  });
});

board.addEventListener('pointerdown',ev=>{
  if(ev.target!==board)return;
  if(placed.length>=6){alert('최대 6개까지만 배치할 수 있습니다.');return;}
  const rect=board.getBoundingClientRect();
  addPlaced(currentTool,ev.clientX-rect.left,ev.clientY-rect.top,60);
});

function addPlaced(type,x,y,size){
  orderCounter++;
  const el=document.createElement('div');
  el.className='placed';
  el.style.left=(x-size/2)+'px';
  el.style.top=(y-size/2)+'px';
  el.style.width=size+'px';
  el.style.height=size+'px';
  el.dataset.id=Date.now()+Math.random();
  el.dataset.type=type;
  el.style.zIndex=100+orderCounter;
  el.dataset.rotate=0;

  const rec={el,type,left:x-size/2,top:y-size/2,size,rotate:0, sTextElement: null};

  if(type==='circle')
    el.innerHTML=`<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" stroke="#3c2f91" stroke-width="6" fill="none"/></svg><div class="badge">${orderCounter}</div>`;
  else if(type==='triangle')
    el.innerHTML=`<svg viewBox="0 0 100 100"><polygon points="50,8 8,92 92,92" stroke="#3c2f91" stroke-width="6" fill="none"/></svg><div class="badge">${orderCounter}</div>`;
  else if(type==='square')
    el.innerHTML=`<svg viewBox="0 0 100 100"><rect x="8" y="8" width="84" height="84" stroke="#3c2f91" stroke-width="6" fill="none"/></svg><div class="badge">${orderCounter}</div>`;
  else {
    const sText = document.createElement('div');
    sText.style.fontSize = `${size * 0.9}px`; 
    sText.style.color = '#3c2f91';
    sText.style.fontWeight = '700';
    sText.style.lineHeight = '1';
    sText.textContent = 'S';
    el.appendChild(sText);
    
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = orderCounter;
    el.appendChild(badge);

    rec.sTextElement = sText; 
  }

  const rot=document.createElement('div');rot.className='rotate-handle';
  el.appendChild(rot);
  board.appendChild(el);

  placed.push(rec);
  makeInteractive(el,null,rot,rec); 
}

function makeInteractive(el,handle,rot,rec){
  // 1. 도형 이동 (손가락 1개 터치)
  el.addEventListener('pointerdown',ev=>{
    if(ev.target===rot)return;
    // 터치 타입이고, 핀치줌이 아닌 경우(손가락 1개)에만 이동
    if(ev.pointerType === 'touch' && touchCount > 1) return;
        
    const startX=ev.clientX,startY=ev.clientY;
    const startLeft=parseFloat(el.style.left),startTop=parseFloat(el.style.top);
    function move(mv){
      const nx=Math.max(0,Math.min(board.clientWidth-rec.size,startLeft+(mv.clientX-startX)));
      const ny=Math.max(0,Math.min(board.clientHeight-rec.size,startTop+(mv.clientY-startY)));
      el.style.left=nx+'px';el.style.top=ny+'px';rec.left=nx;rec.top=ny;
    }
    function up(){window.removeEventListener('pointermove',move);window.removeEventListener('pointerup',up);}
    window.addEventListener('pointermove',move);window.addEventListener('pointerup',up);
  });

  // 2. 회전
  rot.addEventListener('pointerdown',ev=>{
    ev.stopPropagation();
    const rect=el.getBoundingClientRect();
    const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
    function move(mv){
      const angle=Math.atan2(mv.clientY-cy,mv.clientX-cx)*180/Math.PI;
      rec.rotate=angle;el.style.transform=`rotate(${angle}deg)`;
    }
    function up(){window.removeEventListener('pointermove',move);window.removeEventListener('pointerup',up);}
    window.addEventListener('pointermove',move);window.addEventListener('pointerup',up);
  });

  /* 핀치줌 기능 - 도형 크기 조절 (수정된 로직) */
  let initialDistance = 0;
  let initialSize = 0;

  el.addEventListener('touchstart', startEv => {
    // 손가락 2개일 때만 핀치줌 시작
    if (startEv.touches.length !== 2) return;
    
    // **[수정]** 브라우저의 기본 줌 동작을 막아 도형 크기 조절 기능이 작동하도록 함
    startEv.preventDefault(); 
    
    const t1 = startEv.touches[0];
    const t2 = startEv.touches[1];
    
    const dx = t1.clientX - t2.clientX;
    const dy = t1.clientY - t2.clientY;
    initialDistance = Math.sqrt(dx * dx + dy * dy);
    initialSize = rec.size; 

    function move(moveEv) {
      if (moveEv.touches.length !== 2) return; 

      // **[수정]** touchmove 이벤트에서도 기본 동작을 막아 브라우저 줌을 방지
      moveEv.preventDefault(); 

      const t1 = moveEv.touches[0];
      const t2 = moveEv.touches[1];
      const dx = t1.clientX - t2.clientX;
      const dy = t1.clientY - t2.clientY;
      const newDistance = Math.sqrt(dx * dx + dy * dy);

      if (initialDistance === 0) return; 

      const scale = newDistance / initialDistance;
      const newSize = Math.max(20, Math.min(200, Math.round(initialSize * scale))); 
      
      rec.size = newSize;
      el.style.width = newSize + 'px';
      el.style.height = newSize + 'px';

      if (rec.type === 'wave' && rec.sTextElement) {
        rec.sTextElement.style.fontSize = `${newSize * 0.9}px`;
      }
    }

    function up(upEv) {
      window.removeEventListener('touchmove', move);
      window.removeEventListener('touchend', up);
      window.removeEventListener('touchcancel', up);
    }

    // { passive: false }는 preventDefault()를 사용하기 위해 필수적
    window.addEventListener('touchmove', move, { passive: false }); 
    window.addEventListener('touchend', up);
    window.addEventListener('touchcancel', up);
  }, { passive: false }); 
} // makeInteractive 함수 끝

document.getElementById('undo').onclick=()=>{if(!placed.length)return;placed.pop().el.remove();}
document.getElementById('reset').onclick=()=>{
  if(!confirm('모든 도형을 지우시겠습니까?'))return;
  placed.forEach(p=>p.el.remove());placed=[];orderCounter=0;
  resultContent.innerHTML=`<div class="line">도형을 배치한 뒤 '결과 보기'를 눌러주세요.</div>`;
};

/* 분석 (도형심리 프로파일법 적용) */
document.getElementById('analyze').onclick=()=>{
  if(placed.length<4){alert('모든 도형을 배치한 뒤 실행하세요.');return;}

  const counts={};
  placed.forEach(p=>counts[p.type]=(counts[p.type]||0)+1);
  let dominant=Object.keys(counts).find(k=>counts[k]===3)||
    Object.keys(counts).reduce((a,b)=>(counts[a]||0)>=(counts[b]||0)?a:b);

  const zones={상단:0,중단:0,하단:0,좌측:0,중앙:0,우측:0};
  placed.forEach(p=>{
    const cx=p.left+p.size/2,cy=p.top+p.size/2;
    if(cy<board.clientHeight/3)zones.상단++;
    else if(cy>board.clientHeight*2/3)zones.하단++;
    else zones.중단++;
    if(cx<board.clientWidth/3)zones.좌측++;
    else if(cx>board.clientWidth*2/3)zones.우측++;
    else zones.중앙++;
  });

  const profile={
    circle:{
      title:'동그라미 (감성·관계형)',
      lines:['감정이 섬세하고 따뜻한 대인관계를 중시합니다.',
      '타인의 기분을 세심하게 읽고 조율하는 능력이 있습니다.',
      '내면적 평화와 조화를 추구하며, 갈등을 피하려는 경향이 있습니다.',
      '혼자만의 시간에서 에너지를 회복하는 편입니다.'],
      scent:'플로럴·파우더리 계열 (라벤더, 재스민 등)'
    },
    triangle:{
      title:'세모 (목표·리더형)',
      lines:['목표의식이 뚜렷하고 방향감각이 뛰어납니다.',
      '리더십과 추진력이 강하며 성취를 통해 동기부여를 받습니다.',
      '스스로 높은 기준을 세워 꾸준히 도전합니다.',
      '타인의 의견을 듣는 균형 감각이 성장의 포인트입니다.'],
      scent:'시트러스·스파이시 계열 (오렌지, 그레이프프룻 등)'
    },
    square:{
      title:'네모 (안정·체계형)',
      lines:['체계적이고 신뢰감 있는 태도로 일관성을 중시합니다.',
      '책임감이 강하고 실질적 해결을 우선합니다.',
      '예측 가능한 구조에서 안정감을 느낍니다.',
      '가끔은 변화와 유연함이 내적 성장을 이끕니다.'],
      scent:'우디·허브 계열 (샌달우드, 시더 등)'
    },
    wave:{
      title:'S (창의·유연형)',
      lines:['상상력과 표현력이 풍부하며 직관이 뛰어납니다.',
      '틀에 얽매이지 않고 자유로운 사고를 선호합니다.',
      '새로운 자극 속에서 에너지를 얻습니다.',
      '규칙적 반복보다는 감성적 몰입에 강점이 있습니다.'],
      scent:'머스크·프루티 계열 (바닐라, 화이트머스크 등)'
    }
  };

  const dom=profile[dominant];
  let html=`<div class="line"><strong>${dom.title}</strong></div>`;
  dom.lines.forEach(l=>html+=`<div class="line">• ${l}</div>`);

  let posLine='';
  if(zones.상단>zones.중단&&zones.상단>zones.하단)posLine='이 성향이 외부로 활발히 표현되는 시기입니다.';
  else if(zones.하단>zones.중단)posLine='내면의 안정과 자기보호 욕구가 높아진 상태입니다.';
  else posLine='감정과 사고의 균형이 잘 잡힌 상태입니다.';
  html+=`<div class="line">${posLine}</div>`;

  html+=`<div class="line"><strong>추천 향</strong></div><div class="scent">• ${dom.scent}</div>`;
  resultContent.innerHTML=html;
};
</script>
</body>
</html>
